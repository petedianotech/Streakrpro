/**
 * Core Philosophy: This ruleset establishes a security model with four distinct access patterns.
 * User data is strictly private and owner-only. The global leaderboard is publicly readable but
 * entries can only be created by their owner. Daily challenges are publicly readable by any
 * authenticated user but are read-only. A dedicated `usernames` collection enforces unique
 * usernames across the application by using the username itself as the document ID.
 *
 * Data Structure: The data is organized into four top-level collections:
 * 1. /users/{userId}: Contains private user profile information.
 * 2. /leaderboard/{leaderboardEntryId}: A global collection for public scores.
 * 3. /daily_challenges/{dailyChallengeId}: A global collection for daily challenges.
 * 4. /usernames/{username}: A collection where document IDs are lowercase usernames, used for uniqueness checks.
 *
 * Key Security Decisions:
 * - User Listing Disabled: The `/users` collection cannot be listed to protect user privacy.
 * - Ownership Enforcement: Writes to `/users`, `/leaderboard`, and `/usernames` collections are strictly
 *   controlled by checking the authenticated user's UID.
 * - Username Uniqueness: A user can only create a document in `/usernames` if it doesn't already exist.
 *   This is the core mechanism for reserving a unique username. Deletion is also owner-only.
 * - Read-Only Global Data: The `/daily_challenges` collection is read-only for clients.
 * - Google Sign-In: Users can be created with Google, which may pre-fill their username.
 *
 * Denormalization for Authorization: The rules rely on the 'userId' field being denormalized
 * onto each `LeaderboardEntry` and `Username` document. This allows for fast and inexpensive security checks
 * on write operations without needing to perform extra `get()` calls, enforcing Authorization Independence.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------------------------------------------------------
    // Helper Functions
    // ----------------------------------------------------------------------

    /**
     * Checks if the user is authenticated (not anonymous).
     */
    function isSignedIn() {
      return request.auth != null;
    }
    
    /**
     * Checks if the user is a registered user (not anonymous).
     */
    function isRegisteredUser() {
      return isSignedIn() && request.auth.token.firebase.sign_in_provider != 'anonymous';
    }


    /**
     * Checks if the authenticated user's UID matches the provided userId.
     * Used for ownership validation.
     */
    function isOwner(userId) {
      return isRegisteredUser() && request.auth.uid == userId;
    }

    /**
     * Validates that the user ID in the document data matches the user's auth UID on create.
     */
    function createdByOwner() {
      return isOwner(request.resource.data.userId);
    }
    
    /**
     * Ensures the userId field cannot be changed after creation.
     */
    function ownerIsImmutable() {
      return request.resource.data.userId == resource.data.userId;
    }


    // ----------------------------------------------------------------------
    // Collection Rules
    // ----------------------------------------------------------------------

    /**
     * @description Secures the user's private profile document.
     * @path /users/{userId}
     */
    match /users/{userId} {
      allow get, update, delete: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow list: if false; // CRITICAL: Prevent listing all users.
    }

    /**
     * @description Manages entries on the global leaderboard.
     * @path /leaderboard/{leaderboardEntryId}
     */
    match /leaderboard/{leaderboardEntryId} {
      allow get, list: if isSignedIn();
      allow create: if createdByOwner() && request.resource.data.username != null;
      allow update, delete: if false; // Leaderboard entries are immutable.
    }

    /**
     * @description Defines access for daily challenges. Read-only for clients.
     * @path /daily_challenges/{dailyChallengeId}
     */
    match /daily_challenges/{dailyChallengeId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if false;
    }

    /**
     * @description Enforces unique usernames. Document ID is the lowercase username.
     * @path /usernames/{username}
     */
    match /usernames/{username} {
      allow get: if isRegisteredUser();
      // Only the user themselves can create their username document, and only if it doesn't already exist.
      allow create: if createdByOwner() && !exists(/databases/$(database)/documents/usernames/$(username));
      // Only the user who owns the username can delete it.
      allow delete: if isRegisteredUser() && resource.data.userId == request.auth.uid;
      allow update, list: if false;
    }
  }
}
